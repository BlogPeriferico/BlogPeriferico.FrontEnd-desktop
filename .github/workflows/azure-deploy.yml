name: CI/CD Blog PerifÃ©rico Front-End

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  APP_NAME: "BlogPeriferico"
  NODE_VERSION: "20"

concurrency:
  group: blog-periferico-frontend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ========================
  # 1) JOB DE CI (build + lint + test)
  # ========================
  ci:
    name: ğŸ” Build, Lint e Testes
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ğŸ§¹ Limpar build anterior (dist)
        run: rm -rf dist

      - name: ğŸ§ª Lint (NÃƒO bloqueia o pipeline)
        run: |
          echo "â–¶ Rodando ESLint (nÃ£o vai travar o deploy se falhar)..."
          npm run lint --if-present || echo "âš ï¸ ESLint encontrou problemas. Veja os erros acima, mas o pipeline vai continuar."

      - name: ğŸ§ª Testes (NÃƒO bloqueia o pipeline)
        run: |
          echo "â–¶ Rodando testes (nÃ£o vai travar o deploy se falhar)..."
          npm test --if-present || echo "âš ï¸ Testes falharam. Veja os erros acima, mas o pipeline vai continuar."

      - name: ğŸ—ï¸ Build do projeto (Vite)
        run: npm run build

      - name: ğŸ“‚ Listar arquivos gerados
        run: |
          echo "DiretÃ³rio atual:"
          pwd
          echo "ConteÃºdo da raiz:"
          ls
          echo "ConteÃºdo de dist/:"
          ls dist

      - name: ğŸ“¦ Salvar artefato de build (dist)
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          if-no-files-found: error

  # ========================
  # 2) JOB DE DEPLOY
  # ========================
  deploy:
    name: ğŸš€ Deploy para Azure Web App
    needs: ci
    runs-on: ubuntu-latest

    if: github.event_name == 'push' && github.ref == 'refs/heads/dev-matheus'

    environment:
      name: production

    steps:
      - name: ğŸ“¥ Baixar artefato de build
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: ğŸ‘€ Conferir conteÃºdo antes do deploy
        run: |
          echo "DiretÃ³rio atual:"
          pwd
          echo "ConteÃºdo de dist/:"
          ls dist

      - name: ğŸš€ Deploy para Azure (somente dist/)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./dist
          slot-name: production
